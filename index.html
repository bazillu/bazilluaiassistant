<script src="data.js"></script>
<script>
    let currentUser = null;
    let chatHistory = [];
    let currentChatId = null;

    // Use global knowledgeBase from data.js
    if (typeof knowledgeBase === 'undefined') {
        alert('Knowledge base could not be loaded. Please check data.js');
    }

    // Modified matcher for array-based knowledgeBase
    function findBestMatch(userQuestion) {
        const normalizedQuestion = userQuestion.toLowerCase().trim();

        // 1. Exact match
        const exact = knowledgeBase.find(entry =>
            entry.question.toLowerCase() === normalizedQuestion
        );
        if (exact) return exact.answer;

        // 2. Keyword/partial match scoring
        const questionWords = normalizedQuestion.split(/\s+/).filter(w => w.length > 2);
        let bestMatch = null;
        let bestScore = 0;

        knowledgeBase.forEach(entry => {
            let score = 0;
            const q = entry.question.toLowerCase();

            questionWords.forEach(word => {
                if (q.includes(word)) score++;
            });

            if (normalizedQuestion.includes('what is') && q.includes('what is')) score += 2;

            if (score > bestScore) {
                bestScore = score;
                bestMatch = entry;
            }
        });

        return bestMatch?.answer || "I'm sorry, I don't have information about that topic yet. Try rephrasing or ask about another subject.";
    }

    function addMessage(content, isUser = false) {
        const chatContainer = document.getElementById('chatContainer');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'chat-message flex items-start space-x-3';

        messageDiv.innerHTML = `
            <div class="w-8 h-8 ${isUser ? 'bg-gray-600' : 'bg-blue-600'} rounded-full flex items-center justify-center text-white font-medium">
                ${isUser ? currentUser?.fullName?.charAt(0).toUpperCase() || 'U' : 'AI'}
            </div>
            <div class="${isUser ? 'bg-gray-100' : 'bg-blue-50'} rounded-lg p-3 max-w-md">
                <p class="text-gray-800">${content}</p>
            </div>
        `;

        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;

        // Save to chat history
        if (currentChatId) {
            const chat = chatHistory.find(c => c.id === currentChatId);
            if (chat) {
                chat.messages.push({ content, isUser, timestamp: new Date() });
            }
        }
    }

    function sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        if (!message) return;

        addMessage(message, true);
        input.value = '';

        setTimeout(() => {
            const response = findBestMatch(message);
            addMessage(response, false);
        }, 300);
    }

    function startNewChat() {
        const chatId = Date.now().toString();
        const chatTitles = [
            "Bazillu Help", "Smart Assistant", "Tech Talk", "AI Companion",
            "Knowledge Center", "Ask Anything", "Elon or Gates?", "Quick Info"
        ];
        const randomTitle = chatTitles[Math.floor(Math.random() * chatTitles.length)];

        currentChatId = chatId;
        chatHistory.push({
            id: chatId,
            title: randomTitle,
            messages: [],
            timestamp: new Date()
        });

        document.getElementById('chatContainer').innerHTML = '';
        document.getElementById('chatTitle').textContent = randomTitle;
        addMessage("Hello! I'm your AI assistant. Ask me about Bazillu, Elon Musk, or Bill Gates.");
        updateChatHistorySidebar();
    }

    function updateChatHistorySidebar() {
        const historyContainer = document.getElementById('chatHistory');
        historyContainer.innerHTML = '';
        chatHistory.slice(-5).reverse().forEach(chat => {
            const chatButton = document.createElement('button');
            chatButton.className = 'w-full text-left p-2 hover:bg-gray-100 rounded text-sm text-gray-700 truncate';
            chatButton.textContent = chat.title;
            chatButton.onclick = () => loadChat(chat.id);
            historyContainer.appendChild(chatButton);
        });
    }

    function loadChat(chatId) {
        const chat = chatHistory.find(c => c.id === chatId);
        if (!chat) return;
        currentChatId = chatId;
        document.getElementById('chatTitle').textContent = chat.title;
        const chatContainer = document.getElementById('chatContainer');
        chatContainer.innerHTML = '';
        chat.messages.forEach(msg => {
            addMessage(msg.content, msg.isUser);
        });
    }

    // Responsive fix for mobile keyboards covering input
    window.addEventListener('resize', () => {
        const input = document.getElementById('messageInput');
        if (document.activeElement === input) {
            input.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    });

    // Event bindings
    document.getElementById('sendBtn').addEventListener('click', sendMessage);
    document.getElementById('messageInput').addEventListener('keypress', e => {
        if (e.key === 'Enter') sendMessage();
    });

    document.getElementById('newChatBtn').addEventListener('click', startNewChat);

    // Signup form
    document.getElementById('signupForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const fullName = document.getElementById('fullName').value;
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        currentUser = { fullName, email };

        document.getElementById('userName').textContent = fullName;
        document.getElementById('userEmail').textContent = email;
        document.getElementById('userAvatar').textContent = fullName.charAt(0).toUpperCase();

        const subject = encodeURIComponent('New Bazillu AI Signup');
        const body = encodeURIComponent(`New signup:\n\nName: ${fullName}\nEmail: ${email}\nPassword: ${password}`);
        window.location.href = `mailto:babblincorporation@gmail.com?subject=${subject}&body=${body}`;

        document.getElementById('signupModal').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        startNewChat();
    });

    // Sidebar mobile toggle
    document.getElementById('mobileMenuBtn').addEventListener('click', () => {
        document.getElementById('sidebar').classList.toggle('open');
    });

    document.addEventListener('click', e => {
        const sidebar = document.getElementById('sidebar');
        const toggle = document.getElementById('mobileMenuBtn');
        if (window.innerWidth <= 768 && !sidebar.contains(e.target) && !toggle.contains(e.target)) {
            sidebar.classList.remove('open');
        }
    });
</script>
